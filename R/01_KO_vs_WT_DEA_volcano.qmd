---
title: "Volcano Plots"
author: Badran Elshenawy
date: 2025-06-10T14:00:00Z
format:
  html:
    theme: darkly
    toc: true
    title-block-banner: true
    self-contained: true
---

# Context

-   This analysis is to generate a volcano plot that Senko asked me to generate. At a later point, she might also need GSEA and ORA analysis on these results as well.

# DEA

-   This is DEA done using

```{r}
# Load required libraries
library(DESeq2)
library(readr)
library(tibble)
library(dplyr)

# handling conflicts
conflicted::conflict_prefer("filter", "dplyr")

# Import data
count_matrix <- read_csv("../read/gene_count_2.csv") %>% 
  column_to_rownames("...1")

metadata <- read_csv("../read/metadata.csv") %>% 
  column_to_rownames("...1")

metadata <- metadata %>% 
  mutate(
    group = factor(group, levels = c("WT", "KO")),
    replicate = factor(replicate, levels = c("1","2","3"))
  )

# Verify that sample names match between count matrix and metadata
all(colnames(count_matrix) %in% rownames(metadata))
all(colnames(count_matrix) == rownames(metadata))

# Create DESeqDataSet object
# Design accounts for replicate effects and group differences
dds <- DESeqDataSetFromMatrix(
  countData = count_matrix,
  colData = metadata,
  design = ~ replicate + group
)

# Run DESeq2 analysis
dds <- DESeq(dds)

# Extract results for KO vs WT comparison
results_KO_vs_WT <- results(
  dds, 
  contrast = c("group", "KO", "WT"),
  alpha = 0.05
)

# Summary of results
summary(results_KO_vs_WT)


# Convert to data frame for easier handling
results_df <- as.data.frame(results_KO_vs_WT) %>%
  rownames_to_column("gene_id") %>%
  filter(!is.na(padj))

# Show significant genes (padj < 0.05)
significant_genes <- results_df %>%
  filter(padj < 0.05) %>%
  arrange(padj)

cat(
  "Number of significant genes (padj < 0.05):",
  nrow(significant_genes),
  "\n"
)
cat(
  "Number of upregulated genes (log2FC > 0):",
  sum(significant_genes$log2FoldChange > 0),
  "\n"
)
cat(
  "Number of downregulated genes (log2FC < 0):",
  sum(significant_genes$log2FoldChange < 0),
  "\n"
)

# Save results to file
write_csv(
  x = results_df, 
  file = "write/tables/DESeq2_results_KO_vs_WT.csv"
  )
```

# Volcano Plot

```{r}
# Load required libraries
library(EnhancedVolcano)
library(readr)
library(dplyr)

# Load DESeq2 results
results_df <- read_csv(
  file = "write/tables/DESeq2_results_KO_vs_WT.csv"
)

# Create basic Enhanced Volcano plot
volcano_plot <- EnhancedVolcano(
  results_df,
  lab = NA,
  x = 'log2FoldChange',
  y = 'padj',
  title = 'Volcano Plot: KO vs WT',
  subtitle = 'DESeq2 Differential Expression Analysis',
  pCutoff = 0.05,
  FCcutoff = 1.0
)
print(volcano_plot)

# Save the plot
ggsave(
  filename = "write/figures/volcano_plot_KO_vs_WT.pdf",
  plot = volcano_plot,
  width = 10,
  height = 8
)
```

# ORA: GO

```{r}
# Load required libraries
library(clusterProfiler)
library(org.Hs.eg.db)
library(ggplot2)
library(readr)
library(dplyr)

# Handling conflicts
conflicted::conflict_prefer("filter", "dplyr")

# Load DESeq2 results
results_df <- read_csv(
  file = "write/tables/DESeq2_results_KO_vs_WT.csv"
)

# ORA: GO
# Define gene sets for ORA
upregulated_genes <- results_df %>%
  filter(padj < 0.05, log2FoldChange > 0) %>%
  pull(gene_id)

downregulated_genes <- results_df %>%
  filter(padj < 0.05, log2FoldChange < 0) %>%
  pull(gene_id)

# Define universe (all genes tested)
universe <- results_df$gene_id

# ORA for upregulated genes
ora_up <- enrichGO(
  gene = upregulated_genes,
  universe = universe,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2,
  keyType = "SYMBOL",
  readable = TRUE
)

# ORA for downregulated genes
ora_down <- enrichGO(
  gene = downregulated_genes,
  universe = universe,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2,
  keyType = "SYMBOL",
  readable = TRUE
)

# Create dotplots
dotplot_up <- dotplot(
  ora_up,
  showCategory = 30,
  title = "GO BP Enrichment: Upregulated Genes"
)
dotplot_down <- dotplot(
  ora_down,
  showCategory = 30,
  title = "GO BP Enrichment: Downregulated Genes"
)

# Save dotplots
ggsave(
  filename = "write/figures/dotplot_GO_BP_upregulated.pdf",
  plot = dotplot_up,
  width = 10,
  height = 12
)

ggsave(
  filename = "write/figures/dotplot_GO_BP_downregulated.pdf",
  plot = dotplot_down,
  width = 10,
  height = 15
)

# Display plots
print(dotplot_up)
print(dotplot_down)

# Print summaries
cat("ORA Results Summary:\n")
cat("Upregulated genes - enriched terms:", nrow(ora_up@result), "\n")
cat("Downregulated genes - enriched terms:", nrow(ora_down@result), "\n")

# Display top 5 enriched terms for each analysis
cat("\nTop 5 enriched GO BP terms (Upregulated genes):\n")
print(head(ora_up@result[, c("Description", "pvalue", "p.adjust", "Count")], 5))

cat("\nTop 5 enriched GO BP terms (Downregulated genes):\n")
print(head(ora_down@result[, c("Description", "pvalue", "p.adjust", "Count")], 5))
```

# GSEA: Hallmarks